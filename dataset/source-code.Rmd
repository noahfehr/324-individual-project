---
title: "source-code"
output: html_document
---
We've got our data in. Now, we want to manipulate these to end up with two tables. One table with country and total energy consumption; the other with country and renewable energy production
```{r}
library(tidyverse)
library(ggplot2)
renewablebycountry <- read.csv("countrygeneration.csv")
consumptionbycountry <-read.csv("countryconsumption.csv")

# This next block of code is focusing on areas of interest (country and total renewable energy produced)
renewablebycountry <- rename(renewablebycountry, "total" = "Total..TWh.")
renewablebycountry <- select(renewablebycountry, c("Country", "total"))

# the renewablecountry data is from 2017, so we'll just focus on consumption from 2017
consumptionbycountry <- filter(consumptionbycountry, Year == 2017)
# now we want to configure a table based on this data to match the specifications described above
Country <- colnames(consumptionbycountry) [-1]
Consumption <- as.numeric(consumptionbycountry) [-1]
consumptionbycountry <- data.frame(Country, Consumption)

# now we want to merge these together into one table by country
CountryRel <- merge (consumptionbycountry, renewablebycountry, by="Country")
allCountries <- ggplot(CountryRel, aes(x=Consumption, y=total)) +
                    geom_point()

nooutliers <- filter(CountryRel, Country != "China" & Country != "Brazil")

#Remove China (outlier)
noChina <- ggplot(nooutliers, aes(x=Consumption, y=total)) +
  geom_point() +
  xlab("Total Energy Consumption") + 
  ylab("Total Renewable Energy Production") 
  #geom_text(label=nooutliers$Country, nudge_x = 50) #goal is to have these appear when you hover
time <- as.numeric(rep(seq(1,7),each=7))  # x Axis
value <- runif(49, 10, 100)               # y Axis
group <- rep(LETTERS[1:7],times=7)        # group, one shape per group
data <- data.frame(time, value, group)
```
```{r}
library(tidyverse)
library(ggplot2)
library(shiny)

#How has the composition of renewable energy production changed over time?

#Get the data for year by year production of renewable energy
yearbyyear <- read.csv("yearbyyear.csv")

#Rename columns for clearer interpretation
names(yearbyyear) <- c("Year","Hydro","Biofuel", "Solar", "Geothermal")

#Store labels
lbls <- colnames(yearbyyear) [-1]

#Is there a relationship between total energy consumption and renewable energy production?
renewablebycountry <- read.csv("countrygeneration.csv")
consumptionbycountry <-read.csv("countryconsumption.csv")

# This next block of code is focusing on areas of interest (country and total renewable energy produced)
renewablebycountry <- rename(renewablebycountry, "total" = "Total..TWh.")
renewablebycountry <- select(renewablebycountry, c("Country", "total"))

# the renewablecountry data is from 2017, so we'll just focus on consumption from 2017 as well
consumptionbycountry <- filter(consumptionbycountry, Year == 2017)

# now we want to configure a table based on this data to match the specifications described above
Country <- colnames(consumptionbycountry) [-1]
Consumption <- as.numeric(consumptionbycountry) [-1]
consumptionbycountry <- data.frame(Country, Consumption)

# now we want to merge these together into one table by country
CountryRel <- merge (consumptionbycountry, renewablebycountry, by="Country")
    
```
TODO: documentation, update colors
```{r}

ui <- fluidPage(
  navbarPage("Exploring Renewable Energy Production",
  tabPanel("Composition", 
      titlePanel(h3("Composition of Renewable Energy Production", align = "center")),
      fluidRow(
         column(width=2),
         column(
           h4("How has the composition of renewable energy changed over time?", align = "center"),
           h6(p("Use the slider the adjust the year. The bar and pie charts below will display the composition of renewable energy production for this given year. Note how this composition changes from year to year. To recognize trends in composition over time, see the stacked chart below, which will show the renewable energy production from 1997 until the year you select")),
         width=8, 
         style="background-color:azure;border-radius:5"),
         column(width=2)
      ),
      fluidRow(
        column(
          sidebarLayout(position = "left",
                        sidebarPanel(
                          "Year",
                          sliderInput(inputId = "year", 
                                      label = "Slide to adjust the year", 
                                      sep = "",
                                      value = 2015, min = 1997, max = 2017
                                      ),
                          style="background-color:gray85"
                          ),
                        mainPanel(
                          tabsetPanel(
                            tabPanel("Bar", plotOutput("bar")),
                            tabPanel("Pie", plotOutput("pie"))
                          )
                        )
          ), 
          width = 12,
        )
      ),
      fluidRow(
        column(width=2),
        column(plotOutput("stacked"), width = 8),
        column(width=2)
        ),
      fluidRow(
         column(width=2),
         column(
           h6(p("By using the slider to manipulate these visualizations, you should begin to understand the developments in renewable energy production over time. The trends illustrated here lay the groundwork for further inquiry, such as how government support / intervention has supported these developments.")),
         width=8, 
         style="background-color:azure;border-radius:5"),
         column(width=2)
      )
  ),
  tabPanel("Consumption and Production",
      titlePanel(h3("Renewable Energy Production & Total Energy Consumption", align = "center")),
      fluidRow(
         column(width=2),
         column(
           h4("Is there a relationship between total energy consumption and renewable energy production?", align = "center"),
           h6(p("The first scatterplot below highlights China in red, a clear outlier in both total energy consumption and renewable energy production. In order to focus on the relationship between these two variables, we will acknowledge China as an outlier and focus on the remaining countries")),
         width=8, 
         style="background-color:azure;border-radius:5"),
         column(width=2)
      ),
      plotOutput("scatterfull", click = "plot_click"),
      fluidRow(
         column(width=2),
         column(
           h6(p("After removing China, we can visualize the relationship between total energy consumption and renewable energy production. Note how certain countries seem to produce more renewable energy than expected (high renewable energy production with relatively low total energy consumption). Click on any point to see which country that point represents. Country names will display under the scatterplot")),
          width=8, 
          style="background-color:azure;border-radius:5"),
         column(width=2)
      ),
      plotOutput("nochina", click = "nc_click"),
      verbatimTextOutput("info")
      ),
  tabPanel("Methods and Sources",
      fluidRow(
        column(width=2),
        column(
          h2("Project Documentation", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Project Purpose", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("     The overarching purpose of this project is to provide users with meaningful visualizations so that they can understand the development of renewable energy production over time and across the globe. While this project will not crease an exhaustive resource for understanding renewable energy production, I do intend it to enhance viewers' background understanding and lay the foundations for further inquiry. Furthermore, I hope these visualizations can present the developments in such a way that users begin to recognize patterns which coincide with historical and current events defining the renewable energy sector over the past twenty years."),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Data Description", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("     These visualizations are based on data from multiple datasets, which work effectively together to help achieve the purpose defined above."),
          width=8
          ),
        column(width=2)
      ), 
      fluidRow(
        column(width=2),
        column(
          p("(1)	renewablesPowerGeneration97-17 contains the production of renewable energy over the twenty years between 1997 and 2017. Furthermore, it specifies how much of this energy was from hydro, solar & geothermal. Each row represents a single observation (year) and each column represents a single attribute"),
          width=8
          ),
        column(width=2)
      ),
      
      fluidRow(
        column(width=2),
        column(
          p("(2)	top20CountriesPowerGeneration contains the data from 2017 of each of the top 20 countriesâ€™ renewable energy generation. Each row is a single observation (country) and each column represents a single attribute."),
          width=8
          ),
        column(width=2)
      ),
      
      fluidRow(
        column(width=2),
        column(
          p("(3)	Country_Consumption_TWH 2 has the total energy consumption for each year, broken up by country. Each row is an observation (year) and each column is a country. Thus, the cells represent the energy consumed by that country each year."),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Data Collection", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Users of the Visualization", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("This visualization is intended for a general audience of university students interested in renewable energy development and policy. The information conveyed via this visualization will help to provide these students with perspective, insights, and curiousity for their studies."),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Questions to Answer", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("The questions to outline are included on each section; however, they are also included here for complete documentation:"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(1) How has the composition of renewable energy production changed over time? What trends have defined these changes?"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(2) Is there a relationship between total energy consumption and renewable energy production?"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Insights from Data", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Improvements", align="center"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("Although this visualization establishes a strong basis for understanding recent developments in renewable energy policy, there is significant room for further improvements in future work / visualizations:"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(1) This visualization fails to provide significant context for the trends in renewable energy composition. Instead, users are left to view the trends and hypothesize how these came to be. Future studies may incorporate relevant current / historical events as appropriate."),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(2) The limitations of these datasets fail to illustrate these trends over longer periods of time or in recent years. Future visualizations could incorporate more comprehensive data"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(3) To better understand the impact of government action on renewable energy, future apps could group countries in the scatterplots by government policies / actions"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          p("(4) Stronger UI design in more flexible frameworks, such as React, would allow for better interactivity / reactivity and thus a more presentable UI"),
          width=8
          ),
        column(width=2)
      ),
      fluidRow(
        column(width=2),
        column(
          h4("Sources / References", align="center"),
          width=8
          ),
        column(width=2)
      )
  )
)
)

server <- function(input, output) {
  
  output$stacked <- renderPlot({
    #filter the data to only include data from 1997 (earliest date in the data) until value
    currentData <- filter(yearbyyear, Year <= input$year)
    
    #Pivot the data longer, such that each row represents the given energy production for a given source for a certain year
    currentData.long <- currentData %>%
      pivot_longer(-"Year", names_to = "variable", values_to = "value")
    
    #Order the types of energy appropriately so it is easy to see the growth of all variables
    #Note that we will maintain this ordering for all of the charts illustrating composition to keep the colors consistent across the board
    currentData.long$variable <- factor(currentData.long$variable, levels = c("Hydro", "Biofuel", "Geothermal", "Solar"))
    
    #Create the plot
    ggplot(currentData.long, aes(x=Year, y=value, fill=variable)) + 
      geom_area() +
      #Using different hues to demonstrate categorical nature of source
      scale_fill_brewer(palette="Accent") +
      labs(title=paste("Renewable Energy Production from 1990 to", input$year, sep=" "),
           x = "Year",
           y = "Energy Production (TWh)")
  })
  
  output$bar <- renderPlot({
    #filter the data to only include data from this year (specified by slider)
    thisyear <- filter(yearbyyear, Year == input$year)
    
    #Pivot the data longer, so we have one row of data representing each renewable energy source this year
    this.year.long <- thisyear %>%
      pivot_longer(-"Year", names_to = "variable", values_to = "value")
  
    #Order the types appropriately
    this.year.long$variable <- factor(this.year.long$variable, levels = c("Hydro", "Biofuel", "Geothermal", "Solar"))
    
    #Create the bar plot
    ggplot(this.year.long, aes(variable, value, fill = variable)) + 
      geom_bar(stat="identity") +
      scale_fill_brewer(palette="Accent") + 
      labs(title=paste("Composition of renewable energy production in", input$year, sep=" "),
        x = "Renewable Energy Source", y = "Production (TWh)") + 
      theme(legend.position = "none")
  })
  
  output$pie <- renderPlot({
    # ggplot technique - referenced https://www.r-graph-gallery.com/piechart-ggplot2.html
    
    #filter the data to only include data from this year (specified by slider)
    thisyear <- filter(yearbyyear, Year == input$year)
    
    #Pivot the data longer, so we have one row of data representing each renewable energy source this year
    this.year.long <- thisyear %>%
      pivot_longer(-"Year", names_to = "variable", values_to = "value")
    
    #Order the types appropriately
    this.year.long$variable <- factor(this.year.long$variable, levels = c("Hydro", "Biofuel", "Geothermal", "Solar"))
    
    # ggplot technique - referenced https://www.r-graph-gallery.com/piechart-ggplot2.html
    # create the plot
    ggplot(this.year.long, aes(x="", y=value, fill=variable)) +
      geom_bar(stat="identity", width=1, color="white") +
      coord_polar("y", start=0) +
      labs(title=paste("Composition of renewable energy production in", input$year, sep=" "),
        x = "", y = "") +
      scale_fill_brewer(palette="Accent") + 
      theme(legend.position = "right")
    })
  
  
  output$scatterfull <- renderPlot({
    #noChina
    noChina <- filter(CountryRel, Country != "China")
    china <- filter(CountryRel, Country == "China")
    #create the plot
    ggplot(data=noChina, aes( x=Consumption, y=total)) +
    geom_point(alpha=0.3) +
    geom_point(data = china, aes(x=Consumption, y=total), color = 'red') +
    labs(title=paste("Comparison of total energy consumption and renewable energy production in 2017"),
        x = "Total Energy Consumption (TWh)", 
        y = "Renewable Energy Production (TWh)")
    })
    
    #click to display name of country
    output$info <- renderText({
      point <- nearPoints(CountryRel, input$plot_click, threshold = 10, maxpoints = 1)
      if(nrow(point) == 0) return(NULL)
      paste0("Country name: ", point$Country)
  })
  
  output$nochina <- renderPlot({
    #filter the data to exclude China
    noChina <- filter(CountryRel, Country != "China")
    
    #create the plot
    ggplot(noChina, aes(x=Consumption, y=total)) +
    geom_point() +
    labs(title=paste("Comparison of total energy consumption and renewable energy production in 2017 (Excluding China)"),
        x = "Total Energy Consumption (TWh)", 
        y = "Renewable Energy Production (TWh)")
    })
    
    #click to display name of country
    output$info <- renderText({
      point <- nearPoints(CountryRel, input$nc_click, threshold = 10, maxpoints = 1)
      if(nrow(point) == 0) return(NULL)
      paste0("Country name: ", point$Country)
  })
}

shinyApp(ui = ui, server = server)
```